<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin - GestiÃ³n AcadÃ©mica</title>
    <!-- LibrerÃ­a Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: #f0f2f5; 
            color: #333; 
            max-width: 1000px; 
            margin: 0 auto; 
        }
        h1, h2 { text-align: center; color: #0052CC; }
        
        /* --- BotÃ³n de PÃ¡nico (Kill Switch) --- */
        .header-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .btn-toggle {
            padding: 12px 24px;
            font-size: 1em;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.3s;
        }
        .btn-toggle:hover { transform: scale(1.05); }
        .btn-toggle.on { background-color: #2ecc71; } /* Verde */
        .btn-toggle.off { background-color: #e74c3c; } /* Rojo */

        /* --- Panel de Anuncios --- */
        .anuncio-box {
            background: #fff; 
            padding: 20px; 
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
            margin-bottom: 30px;
            border-left: 5px solid #e67e22;
        }
        .anuncio-form { display: flex; gap: 10px; flex-wrap: wrap; }
        .anuncio-form input {
            flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 1em;
        }
        .anuncio-form button {
            background: #e67e22; color: white; border: none; padding: 10px 20px;
            border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1em;
        }
        .anuncio-form button:hover { background: #d35400; }

        /* --- Tarjetas de Solicitud --- */
        .card { 
            background: white; padding: 20px; margin-bottom: 15px; 
            border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            display: flex; justify-content: space-between; align-items: center;
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        
        .info h3 { margin: 0 0 5px 0; color: #333; }
        .info p { margin: 2px 0; color: #555; }
        .motivo { color: #e67e22; font-weight: bold; }

        .actions { display: flex; gap: 10px; }
        
        .btn-accept { background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-reject { background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        
        .loading { text-align: center; color: #666; margin-top: 20px; font-style: italic; }
        .empty-state { text-align: center; padding: 30px; color: #888; background: #fff; border-radius: 12px;}
        
        .status-bar { text-align: center; font-size: 0.9em; margin-bottom: 20px; color: #555; }
        #socket-status { font-weight: bold; color: #e74c3c; }
        #socket-status.connected { color: #2ecc71; }
    </style>
</head>
<body>

    <h1>Panel de AdministraciÃ³n</h1>
    
    <div class="status-bar">
        Estado del Servidor: <span id="socket-status">Conectando...</span>
    </div>

    <!-- BOTÃ“N DE CONTROL GLOBAL (KILL SWITCH) -->
    <div class="header-controls">
        <button id="btn-lock" class="btn-toggle" onclick="toggleSistema()">Cargando estado...</button>
    </div>

    <!-- SECCIÃ“N 1: ANUNCIOS -->
    <div class="anuncio-box">
        <h2>ðŸ“¢ Enviar NotificaciÃ³n General</h2>
        <div class="anuncio-form">
            <input type="text" id="anuncioTitulo" placeholder="TÃ­tulo (Ej: Aviso)" style="flex: 1; min-width: 200px;">
            <input type="text" id="anuncioMensaje" placeholder="Mensaje (Ej: Sistema cerrado por mantenimiento...)" style="flex: 2; min-width: 300px;">
            <button onclick="enviarAnuncio()">ENVIAR A TODOS</button>
        </div>
    </div>

    <hr style="border: 0; border-top: 1px solid #ddd; margin: 30px 0;">

    <!-- SECCIÃ“N 2: SOLICITUDES -->
    <h2>Solicitudes Pendientes</h2>
    <div id="lista-solicitudes">
        <p class="loading">Cargando solicitudes...</p>
    </div>

<script>
    // ðŸš¨ URL DEL BACKEND
    const RENDER_URL = 'https://univbackend.onrender.com';
    const API_BASE = RENDER_URL + '/api/registro'; 

    // --- SOCKET.IO ---
    const socket = io(RENDER_URL);
    const statusEl = document.getElementById('socket-status');

    socket.on('connect', () => {
        statusEl.innerText = 'Conectado (En Vivo)';
        statusEl.classList.add('connected');
        socket.emit('identificarse', 9999); // Admin ID
    });

    socket.on('disconnect', () => {
        statusEl.innerText = 'Desconectado';
        statusEl.classList.remove('connected');
    });

    socket.on('nueva_notificacion', (data) => {
        if (data.tipo === 'solicitud_aceptada' || data.tipo === 'solicitud_rechazada') {
            cargarSolicitudes();
        }
    });

    // Escuchar cambios de estado del sistema (si otro admin lo cambia)
    socket.on('cambio_estado_sistema', (data) => {
        actualizarBotonLock(data.inscripciones_activas);
    });

    // --- FUNCIONES DEL SISTEMA (BLOQUEO) ---

    async function cargarEstadoSistema() {
        const btn = document.getElementById('btn-lock');
        try {
            const res = await fetch(`${API_BASE}/sistema/estado`);
            const data = await res.json();
            actualizarBotonLock(data.inscripciones_activas);
        } catch(e) { btn.innerText = "Error ConexiÃ³n"; }
    }

    async function toggleSistema() {
        if(!confirm("Â¿EstÃ¡s seguro de cambiar el estado de las inscripciones para TODOS los usuarios?")) return;
        try {
            // Llamada al endpoint que creamos en registroRoutes.js
            const res = await fetch(`${API_BASE}/sistema/toggle`, { method: 'POST' });
            const data = await res.json();
            if(data.success) {
                actualizarBotonLock(data.inscripciones_activas);
                alert("Estado del sistema actualizado.");
            }
        } catch(e) { alert("Error al cambiar estado"); }
    }

    function actualizarBotonLock(activo) {
        const btn = document.getElementById('btn-lock');
        if (activo) {
            btn.innerText = "ðŸŸ¢ INSCRIPCIONES ABIERTAS (Click para CERRAR)";
            btn.className = "btn-toggle on";
        } else {
            btn.innerText = "ðŸ”´ INSCRIPCIONES CERRADAS (Click para ABRIR)";
            btn.className = "btn-toggle off";
        }
    }

    // --- FUNCIONES DE SOLICITUDES ---

    async function cargarSolicitudes() {
        const container = document.getElementById('lista-solicitudes');
        try {
            const res = await fetch(`${API_BASE}/solicitudes`);
            const data = await res.json();
            
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<div class="empty-state">No hay solicitudes pendientes.</div>';
                return;
            }

            data.forEach(sol => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="info">
                        <h3>${sol.estudiante} <small>(ID: ${sol.id_estudiante})</small></h3>
                        <p>Solicita: <strong>${sol.materia}</strong> (${sol.nombre_paralelo})</p>
                        <p class="motivo">Motivo: ${sol.motivo}</p>
                        <small>${new Date(sol.fecha_solicitud).toLocaleString()}</small>
                    </div>
                    <div class="actions">
                        <button class="btn-accept" onclick="resolver(${sol.id}, ${sol.id_estudiante}, '${sol.materia}', 'Aceptada', ${sol.id_paralelo})">Aceptar</button>
                        <button class="btn-reject" onclick="resolver(${sol.id}, ${sol.id_estudiante}, '${sol.materia}', 'Rechazada', ${sol.id_paralelo})">Rechazar</button>
                    </div>
                `;
                container.appendChild(card);
            });
        } catch (e) {
            container.innerHTML = `<p style="color:red; text-align:center">Error: ${e.message}</p>`;
        }
    }

    async function resolver(id, idEst, materia, accion, idParalelo) {
        if(!confirm(`Â¿Marcar como ${accion.toUpperCase()}?`)) return;
        try {
            const res = await fetch(`${API_BASE}/resolver`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id_solicitud: id, id_estudiante: idEst, materia, accion, id_paralelo: idParalelo })
            });
            const data = await res.json();
            if (res.ok) {
                cargarSolicitudes();
            } else {
                alert(`Error: ${data.error}`);
            }
        } catch (e) { alert("Error de conexiÃ³n"); }
    }

    async function enviarAnuncio() {
        const titulo = document.getElementById('anuncioTitulo').value;
        const mensaje = document.getElementById('anuncioMensaje').value;
        if(!titulo || !mensaje) return alert("Faltan datos.");

        if(!confirm("Â¿Enviar a TODOS los estudiantes?")) return;

        try {
            const res = await fetch(`${API_BASE}/anuncio`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ titulo, mensaje })
            });
            const data = await res.json();
            if (res.ok) {
                alert(`âœ… ${data.message}`);
                document.getElementById('anuncioTitulo').value = '';
                document.getElementById('anuncioMensaje').value = '';
            }
        } catch (e) { alert("Error de conexiÃ³n"); }
    }

    // InicializaciÃ³n
    window.onload = () => {
        cargarSolicitudes();
        cargarEstadoSistema(); // Cargar estado del botÃ³n de bloqueo
    };
    
    setInterval(cargarSolicitudes, 30000);
</script>

</body>
</html>